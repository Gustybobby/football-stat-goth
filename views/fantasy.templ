package views

import (
	"football-stat-goth/queries"
	"football-stat-goth/views/components"
	"football-stat-goth/views/components/playercard_components"
	"football-stat-goth/views/layouts"
	"strconv"
)

script onDeletePlayerCard(position string, i int) {
	counter[position] = i - 1;
	const count_input = document.getElementById(position+"_count");
	count_input.value = Math.max(Math.min(Number(count_input.value) - 1, posMax[position] - 1), 0);
}

script onAddPlayerCard(position string, i int) {
	counter[position] += 1;
	document.getElementById("card_" + i).setAttribute('hx-target', '#' + position + '_'+ counter[position]);
	const count_input = document.getElementById(position+"_count");
	if (Number(count_input.value) <= posMax[position]) {
		count_input.value = Number(count_input.value) + 1;
	}
	if (counter[position] >= posMax[position] - 1){
		counter[position] = -1;
	}
}

templ Fantasy(
	user *queries.FindUserByUsernameRow,
	fixtures []queries.ListMatchesWithClubsAndGoalsRow,
	players []queries.ListFantasyPlayersRow,
) {
	@layouts.Base() {
		@components.Fixture(fixtures)
		@components.Nav(user)
		<script>
			const counter = {
				"GK": -1,
				"DEF": -1,
				"MFD": -1,
				"FWD": -1,
			};
			const posMax = {
				"GK": 1,
				"DEF": 4,
				"MFD": 4,
				"FWD": 2
			};
		</script>
		<main class="w-full p-4 bg-primary-background min-h-screen flex flex-initial place-content-center">
			<div class="max-w-5xl">
				<section class="w-full flex px-2 py-8 space-x-4 flex-row">
					// Field Area
					<section class="basis-2/3 overflow-hidden">
						<h1 class="text-xl text-center font-bold p-2 bg-gradient-to-br from-secondary-foreground to-secondary-background text-primary-background rounded-t-lg">
							Your Team
						</h1>
						<div
							class="relative w-full h-[700px] rounded-b-lg items-center shadow-lg bg-gradient-to-tr from-secondary-foreground from-20% via-sky-500 via-50% to-emerald-500 to-90%"
						>
							<img
								class="w-full h-full"
								src="/public/1-1-football-pitch.png"
							/>
							// make 3 section for each row instead, then make section within thos.
							<div class="absolute inset-0 flex items-center px-14">
								<section class="w-full h-[80%] grid grid-rows-4 place-content-center gap-y-11 -translate-y-11">
									<section class="flex justify-center" onclick="SetFilter('GK')">
										for i := range(1) {
											<div
												id={ "GK_" + strconv.Itoa(i) }
												hx-trigger="click"
												hx-post="/cmps/fantasy/player-card?blank=true"
												onclick={ onDeletePlayerCard("GK", i) }
											>
												@playercard_components.BlankPlayerCard()
											</div>
										}
									</section>
									<section class="flex justify-center -translate-y-8" onclick="SetFilter('DEF')">
										for i := range(4) {
											<div
												id={ "DEF_" + strconv.Itoa(i) }
												hx-trigger="click"
												hx-post="/cmps/fantasy/player-card?blank=true"
												onclick={ onDeletePlayerCard("DEF", i) }
											>
												@playercard_components.BlankPlayerCard()
											</div>
										}
									</section>
									<section class="flex justify-center -translate-y-8" onclick="SetFilter('MFD')">
										for i := range(4) {
											<div
												id={ "MFD_" + strconv.Itoa(i) }
												hx-trigger="click"
												hx-post="/cmps/fantasy/player-card?blank=true"
												onclick={ onDeletePlayerCard("MFD", i) }
											>
												@playercard_components.BlankPlayerCard()
											</div>
										}
									</section>
									<section class="flex justify-center -translate-y-8" onclick="SetFilter('FWD')">
										for i := range(2) {
											<div
												id={ "FWD_" + strconv.Itoa(i) }
												hx-trigger="click"
												hx-post="/cmps/fantasy/player-card?blank=true"
												onclick={ onDeletePlayerCard("FWD", i) }
											>
												@playercard_components.BlankPlayerCard()
											</div>
										}
									</section>
								</section>
							</div>
							<input id="GK_count" name="GK_count" value="0" hidden/>
							<input id="DEF_count" name="DEF_count" value="0" hidden/>
							<input id="MFD_count" name="MFD_count" value="0" hidden/>
							<input id="FWD_count" name="FWD_count" value="0" hidden/>
						</div>
					</section>
					// Select Player Area
					<div class="basis-1/3 flex flex-col space-y-4 transition-all">
						<section class="rounded-lg border border-primary shadow-lg w-full">
							<h1 class="text-xl text-center font-bold p-2 bg-gradient-to-br from-secondary-foreground to-secondary-background text-primary-background rounded-t-lg">
								Players
							</h1>
							<div class="flex flex-col h-[700px]">
								<div class="flex h-10 m-4 border border-gray-300 rounded">
									<input type="text" id="searchFilter" placeholder="Name | Club" class="h-full w-2/3 px-2"/>
									<select id="checkedFilter" class="h-full w-1/3 border-l" title="Option">
										<optgroup label="All">
											<option aria-selected="true">All</option>
										</optgroup>
										<optgroup label="Position" class="mx-2">
											<option class="pos-option">GK</option>
											<option class="pos-option">DEF</option>
											<option class="pos-option">MFD</option>
											<option class="pos-option">FWD</option>
										</optgroup>
									</select>
								</div>
								<ul class="px-4 size-full overflow-scroll grid grid-cols-2">
									for _,player := range players {
										<div
											id={ "card_" + strconv.Itoa(int(player.ID)) }
											class="flex justify-center player-card m-2 hover: cursor-pointer"
											hx-post={ "/cmps/fantasy/player-card?fantasy_player_id=" + strconv.Itoa(int(player.ID)) + "&position=" + string(player.Position) }
											hx-include={ "#" + string(player.Position) + "_count" }
											hx-trigger="click"
											hx-target={ "#" + string(player.Position) + "_" + "0" }
											hx-swap="innerHTML"
											onclick={ onAddPlayerCard(string(player.Position), int(player.ID)) }
										>
											<div class="flip-card w-32 h-40">
												<div class="flip-card-inner">
													<div class="flip-card-front relative">
														// front side, user playercard_front
														@playercard_components.PlayerCardImg(player)
													</div>
													<div class="flip-card-back relative">
														// back side, user playercard_back
														@playercard_components.PlayerCardInfo(player)
													</div>
												</div>
											</div>
										</div>
									}
								</ul>
								<script>
									// Init variables for player filter
									var searchFilter = document.getElementById('searchFilter').value.toLowerCase(), 
										checkedFilter = document.getElementById('checkedFilter').value.toLowerCase(),
										searchEmpty = (searchFilter.length == 0),
										checkedAll = (checkedFilter.includes('all'));

									function UpdateField() {
										searchFilter = document.getElementById('searchFilter').value.toLowerCase(), 
										checkedFilter = document.getElementById('checkedFilter').value.toLowerCase(),
										searchEmpty = (searchFilter.length == 0),
										checkedAll = (checkedFilter.includes('all'));
									}

									document.getElementById('searchFilter').addEventListener('input', function(){
										PlayerCardFilter();
									});

									document.getElementById('checkedFilter').addEventListener('input', function(){
										PlayerCardFilter()
									});

									function PlayerCardFilter() {
										UpdateField()
										const cards = document.querySelectorAll('.player-card');

										cards.forEach(card => {
											const name = card.querySelector('.player-name').textContent.toLowerCase();
											const club = card.querySelector('.player-club').textContent.toLowerCase();
											const pos = card.querySelector('.player-pos').textContent.toLowerCase();
											if ( searchEmpty && checkedAll ) {
												card.style.display = '';
											}
											else if ( searchEmpty && !checkedAll) { // search empty
												if ( pos.includes(checkedFilter) ) {
													card.style.display = '';
												} else {
													card.style.display = 'none';
												}
											}
											else if ( !searchEmpty && checkedAll ) { // all checked
												if ( (name.includes(searchFilter) || club.includes(searchFilter)) ) {
													card.style.display = '';
												} else {
													card.style.display = 'none';
												}
											}
											else {
												if ( (name.includes(searchFilter) || club.includes(searchFilter)) && (pos.includes(checkedFilter)) ) {
													card.style.display = '';
												} else {
													card.style.display = 'none';
												}
											}
										});
									}

									// Interactive fantasy section
									function SetFilter(pos) {
										const 
											selector = document.getElementById('checkedFilter'),
											options = selector.querySelector('optgroup[label="Position"]').querySelectorAll('.pos-option');

										for (let i = 0; i < options.length; i++) {
											if (options[i].textContent.toLocaleLowerCase() === pos.toLowerCase()) {
												selector.selectedIndex = options[i].index;
												PlayerCardFilter();
												return;
											}
										}
									}
								</script>
							</div>
						</section>
					</div>
				</section>
			</div>
		</main>
	}
}
